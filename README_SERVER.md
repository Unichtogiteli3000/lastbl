# Серверная часть музыкальной библиотеки

## Описание
Серверная часть веб-приложения "Музыкальная библиотека" реализована с использованием Flask и PostgreSQL. Сервер обеспечивает аутентификацию пользователей, обработку API-запросов и взаимодействие с базой данных через хранимые процедуры.

## Архитектура
- **Flask** - веб-фреймворк для создания API
- **PostgreSQL** - реляционная база данных
- **Хранимые процедуры** - все операции с БД выполняются через хранимые процедуры на языке PL/pgSQL
- **JWT** - токены для аутентификации
- **Триггеры** - автоматическое журналирование операций

## Функциональность

### Аутентификация
- `/api/auth/login` - вход в систему
- `/api/auth/register` - регистрация нового пользователя

### Профиль пользователя
- `/api/profile` (GET) - получение профиля пользователя
- `/api/profile` (PUT) - обновление профиля пользователя

### Управление данными
- `/api/genres` - получение списка жанров
- `/api/artists` - CRUD операции с исполнителями
- `/api/tracks` - CRUD операции с треками
- `/api/collections` - CRUD операции с коллекциями
- `/api/collections/{collection_id}/tracks` - добавление/удаление треков из коллекции
- `/api/search/tracks` - поиск треков по различным критериям

### Админ-панель
- `/api/admin/users` - просмотр всех пользователей
- `/api/admin/tracks` - просмотр всех треков
- `/api/admin/audit` - просмотр журнала операций

## Установка и запуск

### Требования
- Python 3.8+
- PostgreSQL 12+

### Установка зависимостей
```bash
pip install -r requirements.txt
```

### Настройка базы данных
1. Создайте базу данных PostgreSQL:
```sql
CREATE DATABASE music_library;
```

2. Выполните скрипт создания схемы:
```bash
psql -d music_library -f database_schema.sql
```

### Настройка конфигурации
Создайте файл `.env` с настройками подключения к базе данных:
```bash
export DB_HOST=localhost
export DB_NAME=music_library
export DB_USER=postgres
export DB_PASSWORD=your_password
export SECRET_KEY=your_secret_key_here
```

### Запуск сервера
```bash
python server.py
```

Сервер будет доступен по адресу `http://localhost:5000`

## Безопасность
- Все операции с базой данных выполняются через хранимые процедуры
- Реализовано разграничение прав доступа (пользователь/администратор)
- Используется JWT-аутентификация
- Все пароли хранятся в зашифрованном виде
- Ведется журнал всех операций (аудит)

## Тестовые учетные записи
- Администратор: `login: admin`, `password: admin`
- Обычный пользователь: `login: user`, `password: user`

## Особенности реализации

### Хранимые процедуры
Все взаимодействие с базой данных происходит через хранимые процедуры, написанные на языке PL/pgSQL:
- `authenticate_user()` - аутентификация пользователя
- `register_user()` - регистрация пользователя
- `get_user_profile()` - получение профиля
- `add_track()`, `update_track()`, `delete_track()` - операции с треками
- `create_collection()`, `update_collection()`, `delete_collection()` - операции с коллекциями
- и другие

### Триггеры аудита
Для автоматического журналирования операций созданы триггеры:
- `audit_track_operations()` - журналирует операции с треками
- `audit_user_operations()` - журналирует операции с пользователями

### Разграничение прав
- Обычные пользователи могут работать только со своими данными
- Администраторы имеют доступ ко всей базе данных
- Админ-функции защищены декоратором `@admin_required`

## Структура API

### Аутентификация
Все защищенные маршруты требуют JWT-токен в заголовке Authorization:
```
Authorization: Bearer <token>
```

### Примеры запросов

#### Вход в систему
```
POST /api/auth/login
Content-Type: application/json

{
  "login": "user",
  "password": "user"
}
```

#### Получение треков пользователя
```
GET /api/tracks
Authorization: Bearer <token>
```

#### Добавление трека
```
POST /api/tracks
Authorization: Bearer <token>
Content-Type: application/json

{
  "title": "Название трека",
  "artist_id": 1,
  "genre_id": 2,
  "bpm": 120,
  "duration_sec": 180
}
```

## Требования к заданию РПБД

Реализованные требования:
- ✅ Клиент-серверная архитектура
- ✅ Использование хранимых процедур (PL/pgSQL)
- ✅ Все запросы к БД через хранимые процедуры
- ✅ Журналирование операций (аудит)
- ✅ Разграничение прав доступа (пользователь/администратор)
- ✅ Триггеры для каскадных операций и проверки целостности